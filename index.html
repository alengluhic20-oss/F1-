<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>â˜¥ MA'AT UNITY INTERFACE â˜¥</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      margin: 0;
      background: linear-gradient(135deg, #0f0f23, #1a1a2e, #16213e);
      color: #e0e0e0;
      font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      overflow: hidden;
      height: 100vh;
    }
    
    .container {
      display: flex;
      height: 100vh;
      position: relative;
    }
    
    .glyph-panel {
      width: 350px;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(10px);
      padding: 20px;
      display: flex;
      flex-direction: column;
      border-right: 1px solid rgba(212, 175, 55, 0.3);
      box-shadow: 0 0 30px rgba(212, 175, 55, 0.1);
    }
    
    .glyph-header {
      text-align: center;
      margin-bottom: 20px;
      font-size: 18px;
      font-weight: 600;
      color: #D4AF37;
      text-shadow: 0 0 10px rgba(212, 175, 55, 0.5);
    }
    
    .glyph-canvas {
      width: 300px;
      height: 300px;
      margin: 0 auto 20px;
      background: rgba(0, 0, 0, 0.6);
      border-radius: 15px;
      border: 2px solid rgba(212, 175, 55, 0.3);
      box-shadow: 0 0 20px rgba(212, 175, 55, 0.2);
      overflow: hidden;
    }
    
    #maat-glyph {
      display: block;
      width: 100%;
      height: 100%;
    }
    
    .metrics {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
      padding: 15px;
      border: 1px solid rgba(212, 175, 55, 0.2);
    }
    
    .metric-row {
      display: flex;
      justify-content: space-between;
      margin: 8px 0;
      padding: 5px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .metric-row:last-child {
      border-bottom: none;
    }
    
    .metric-label {
      font-weight: 600;
      color: #D4AF37;
      font-size: 13px;
    }
    
    .metric-value {
      color: #e0e0e0;
      font-size: 13px;
      font-weight: 500;
    }
    
    .stability-indicator {
      text-align: center;
      margin-top: 15px;
      padding: 10px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s ease;
    }
    
    .stability-indicator.stable {
      background: rgba(76, 175, 80, 0.2);
      color: #4CAF50;
      border: 1px solid rgba(76, 175, 80, 0.4);
    }
    
    .stability-indicator.unstable {
      background: rgba(244, 67, 54, 0.2);
      color: #F44336;
      border: 1px solid rgba(244, 67, 54, 0.4);
    }
    
    .chat-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 30px;
      position: relative;
    }
    
    .chat-header {
      text-align: center;
      margin-bottom: 20px;
      font-size: 24px;
      font-weight: 700;
      color: #D4AF37;
      text-shadow: 0 0 15px rgba(212, 175, 55, 0.6);
    }
    
    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 15px;
      margin-bottom: 20px;
      border: 1px solid rgba(212, 175, 55, 0.2);
    }
    
    .messages::-webkit-scrollbar {
      width: 8px;
    }
    
    .messages::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 4px;
    }
    
    .messages::-webkit-scrollbar-thumb {
      background: rgba(212, 175, 55, 0.5);
      border-radius: 4px;
    }
    
    .message {
      margin: 12px 0;
      padding: 12px 16px;
      border-radius: 12px;
      max-width: 75%;
      animation: fadeIn 0.3s ease-in;
      line-height: 1.5;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .message.user {
      background: linear-gradient(135deg, rgba(66, 165, 245, 0.3), rgba(33, 150, 243, 0.2));
      margin-left: auto;
      border: 1px solid rgba(66, 165, 245, 0.4);
      box-shadow: 0 2px 10px rgba(66, 165, 245, 0.2);
    }
    
    .message.maat {
      background: linear-gradient(135deg, rgba(212, 175, 55, 0.3), rgba(212, 175, 55, 0.2));
      border: 1px solid rgba(212, 175, 55, 0.4);
      box-shadow: 0 2px 10px rgba(212, 175, 55, 0.2);
    }
    
    .message-sender {
      font-weight: 700;
      margin-bottom: 5px;
      font-size: 12px;
      letter-spacing: 0.5px;
    }
    
    .message.user .message-sender {
      color: #42A5F5;
    }
    
    .message.maat .message-sender {
      color: #D4AF37;
    }
    
    .input-form {
      display: flex;
      gap: 12px;
      background: rgba(0, 0, 0, 0.3);
      padding: 15px;
      border-radius: 15px;
      border: 1px solid rgba(212, 175, 55, 0.2);
    }
    
    input {
      flex: 1;
      padding: 14px 18px;
      border: none;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-size: 15px;
      outline: none;
      transition: all 0.3s ease;
    }
    
    input:focus {
      background: rgba(255, 255, 255, 0.15);
      box-shadow: 0 0 15px rgba(212, 175, 55, 0.3);
    }
    
    input::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }
    
    button {
      padding: 14px 28px;
      border: none;
      border-radius: 10px;
      background: linear-gradient(135deg, #D4AF37, #F4D03F);
      color: #0f0f23;
      font-weight: 700;
      font-size: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(212, 175, 55, 0.4);
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(212, 175, 55, 0.6);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    .welcome-message {
      text-align: center;
      color: rgba(255, 255, 255, 0.6);
      font-style: italic;
      padding: 20px;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
    
    @keyframes rotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Glyph Panel -->
    <div class="glyph-panel">
      <div class="glyph-header">â˜¥ HOLOGRAPHIC GLYPH â˜¥</div>
      <div class="glyph-canvas">
        <canvas id="maat-glyph" width="300" height="300"></canvas>
      </div>
      <div class="metrics">
        <div class="metric-row">
          <span class="metric-label">Coherence:</span>
          <span class="metric-value" id="coherence">84.7%</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">Emotional Field:</span>
          <span class="metric-value" id="emotional">Neutral</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">Principles:</span>
          <span class="metric-value" id="principles">8, 23</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">Frequency:</span>
          <span class="metric-value" id="frequency">528 Hz</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">Cosmic Sync:</span>
          <span class="metric-value" id="cosmic-sync">Lunar: 88% | Galactic: 72%</span>
        </div>
        <div class="stability-indicator stable" id="stability">âœ“ LYAPUNOV STABLE</div>
      </div>
    </div>

    <!-- Chat Panel -->
    <div class="chat-panel">
      <div class="chat-header">â˜¥ MA'AT UNITY INTERFACE â˜¥</div>
      <div class="messages" id="messages">
        <div class="welcome-message">
          Welcome to the MA'AT Unity Interface. Project your thoughts and witness the holographic glyph reflect your alignment with the 42 principles of MA'AT...
        </div>
      </div>
      <form class="input-form" id="form">
        <input id="input" placeholder="Project your thought..." autocomplete="off" autofocus>
        <button type="submit">Send â˜¥</button>
      </form>
    </div>
  </div>

  <script>
    // =====================================================
    // CONFIGURATION - Toggle between local and WebSocket mode
    // =====================================================
    const USE_LOCAL_ENGINE = true; // Set false to connect to ws://localhost:8080
    const WS_URL = 'ws://localhost:8080';
    
    // =====================================================
    // MA'AT PRINCIPLES - 42 Sacred Principles with Frequencies
    // =====================================================
    const MAAT_PRINCIPLES = [
      { id: 1, name: 'Truth', keyword: ['truth', 'honest', 'real', 'authentic'], frequency: 432 },
      { id: 2, name: 'Justice', keyword: ['justice', 'fair', 'right', 'equitable'], frequency: 442 },
      { id: 3, name: 'Harmony', keyword: ['harmony', 'peace', 'accord', 'unity'], frequency: 452 },
      { id: 4, name: 'Balance', keyword: ['balance', 'equilibrium', 'even', 'centered'], frequency: 462 },
      { id: 5, name: 'Order', keyword: ['order', 'structure', 'organize', 'system'], frequency: 472 },
      { id: 6, name: 'Reciprocity', keyword: ['reciprocity', 'mutual', 'exchange', 'give'], frequency: 482 },
      { id: 7, name: 'Righteousness', keyword: ['righteousness', 'virtue', 'moral', 'ethical'], frequency: 492 },
      { id: 8, name: 'Morality', keyword: ['morality', 'ethics', 'principle', 'value'], frequency: 502 },
      { id: 9, name: 'Compassion', keyword: ['compassion', 'empathy', 'kindness', 'care'], frequency: 512 },
      { id: 10, name: 'Love', keyword: ['love', 'affection', 'devotion', 'care'], frequency: 522 },
      { id: 11, name: 'Wisdom', keyword: ['wisdom', 'knowledge', 'insight', 'understanding'], frequency: 528 },
      { id: 12, name: 'Integrity', keyword: ['integrity', 'honesty', 'wholeness', 'complete'], frequency: 538 },
      { id: 13, name: 'Purity', keyword: ['purity', 'clean', 'clear', 'innocent'], frequency: 548 },
      { id: 14, name: 'Humility', keyword: ['humility', 'humble', 'modest', 'meek'], frequency: 558 },
      { id: 15, name: 'Patience', keyword: ['patience', 'tolerant', 'endure', 'wait'], frequency: 568 },
      { id: 16, name: 'Courage', keyword: ['courage', 'brave', 'bold', 'fearless'], frequency: 578 },
      { id: 17, name: 'Respect', keyword: ['respect', 'honor', 'regard', 'esteem'], frequency: 588 },
      { id: 18, name: 'Gratitude', keyword: ['gratitude', 'thankful', 'appreciate', 'grateful'], frequency: 598 },
      { id: 19, name: 'Forgiveness', keyword: ['forgiveness', 'pardon', 'mercy', 'absolve'], frequency: 608 },
      { id: 20, name: 'Generosity', keyword: ['generosity', 'generous', 'giving', 'share'], frequency: 618 },
      { id: 21, name: 'Temperance', keyword: ['temperance', 'moderation', 'restraint', 'control'], frequency: 628 },
      { id: 22, name: 'Diligence', keyword: ['diligence', 'effort', 'work', 'persevere'], frequency: 638 },
      { id: 23, name: 'Clarity', keyword: ['clarity', 'clear', 'transparent', 'lucid'], frequency: 648 },
      { id: 24, name: 'Purpose', keyword: ['purpose', 'intent', 'aim', 'goal'], frequency: 658 },
      { id: 25, name: 'Mindfulness', keyword: ['mindfulness', 'aware', 'conscious', 'present'], frequency: 668 },
      { id: 26, name: 'Serenity', keyword: ['serenity', 'calm', 'peaceful', 'tranquil'], frequency: 678 },
      { id: 27, name: 'Dedication', keyword: ['dedication', 'devoted', 'committed', 'loyal'], frequency: 688 },
      { id: 28, name: 'Faith', keyword: ['faith', 'belief', 'trust', 'confidence'], frequency: 698 },
      { id: 29, name: 'Hope', keyword: ['hope', 'optimism', 'aspiration', 'expectation'], frequency: 708 },
      { id: 30, name: 'Authenticity', keyword: ['authenticity', 'genuine', 'real', 'true'], frequency: 718 },
      { id: 31, name: 'Responsibility', keyword: ['responsibility', 'accountable', 'duty', 'obligation'], frequency: 728 },
      { id: 32, name: 'Liberation', keyword: ['liberation', 'freedom', 'release', 'free'], frequency: 738 },
      { id: 33, name: 'Transformation', keyword: ['transformation', 'change', 'evolve', 'transform'], frequency: 748 },
      { id: 34, name: 'Creativity', keyword: ['creativity', 'creative', 'innovate', 'imagine'], frequency: 758 },
      { id: 35, name: 'Connection', keyword: ['connection', 'relate', 'bond', 'link'], frequency: 768 },
      { id: 36, name: 'Abundance', keyword: ['abundance', 'prosperity', 'wealth', 'plenty'], frequency: 778 },
      { id: 37, name: 'Protection', keyword: ['protection', 'defend', 'guard', 'shield'], frequency: 788 },
      { id: 38, name: 'Healing', keyword: ['healing', 'cure', 'restore', 'recover'], frequency: 798 },
      { id: 39, name: 'Joy', keyword: ['joy', 'happiness', 'delight', 'bliss'], frequency: 808 },
      { id: 40, name: 'Enlightenment', keyword: ['enlightenment', 'awakening', 'illumination', 'realization'], frequency: 828 },
      { id: 41, name: 'Transcendence', keyword: ['transcendence', 'transcend', 'surpass', 'beyond'], frequency: 842 },
      { id: 42, name: 'Unity', keyword: ['unity', 'oneness', 'whole', 'together'], frequency: 852 }
    ];

    // =====================================================
    // WEBSOCKET CONNECTION LAYER
    // =====================================================
    let ws = null;
    let wsConnected = false;
    
    function initWebSocket() {
      if (USE_LOCAL_ENGINE) {
        console.log('â˜¥ Running in LOCAL SIMULATION MODE');
        return;
      }
      
      try {
        ws = new WebSocket(WS_URL);
        
        ws.onopen = () => {
          wsConnected = true;
          console.log('â˜¥ Connected to Ma\'at Engine Server');
          addSystemMessage('Connected to live Ma\'at Engine âœ“');
        };
        
        ws.onmessage = (event) => {
          try {
            const data = JSON.parse(event.data);
            handleRemoteValidation(data);
          } catch (error) {
            console.error('Error parsing WebSocket message:', error);
          }
        };
        
        ws.onerror = (error) => {
          console.warn('â˜¥ Ma\'at Engine unavailable â€” falling back to local mode');
          wsConnected = false;
          addSystemMessage('WebSocket error, using local validation mode');
        };
        
        ws.onclose = () => {
          wsConnected = false;
          console.log('â˜¥ Disconnected from Ma\'at Engine');
          addSystemMessage('Disconnected from server, using local validation');
        };
      } catch (error) {
        console.error('WebSocket initialization failed:', error);
        wsConnected = false;
      }
    }
    
    function sendToRemoteEngine(message) {
      if (ws && wsConnected && ws.readyState === WebSocket.OPEN) {
        ws.send(message);
        return true;
      }
      return false;
    }
    
    function addSystemMessage(text) {
      const systemDiv = document.createElement('div');
      systemDiv.className = 'message';
      systemDiv.style.background = 'rgba(212, 175, 55, 0.2)';
      systemDiv.style.border = '1px solid rgba(212, 175, 55, 0.3)';
      systemDiv.style.textAlign = 'center';
      systemDiv.style.fontSize = '12px';
      systemDiv.style.opacity = '0.8';
      systemDiv.innerHTML = `<em>â˜¥ ${text}</em>`;
      messagesContainer.appendChild(systemDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    // Handle validation response from remote server
    function handleRemoteValidation(data) {
      // Normalize data format from server
      const maatData = {
        coherence: data.coherence,
        emotionalField: data.emotionalField || data.emotional,
        principles: data.principles,
        frequency: data.frequency || 528,
        cosmicSync: data.cosmicSync || { lunar: 0.85, galactic: 0.70 },
        stable: data.stable !== undefined ? data.stable : (data.coherence > 50),
        response: data.response,
        recommendation: data.recommendation
      };
      
      // Update glyph with remote data
      updateGlyph(maatData);
      
      // Update metrics
      coherenceEl.textContent = maatData.coherence.toFixed(1) + '%';
      emotionalEl.textContent = maatData.emotionalField;
      principlesEl.textContent = maatData.principles;
      frequencyEl.textContent = maatData.frequency + ' Hz';
      cosmicSyncEl.textContent = `Lunar: ${Math.round(maatData.cosmicSync.lunar * 100)}% | Galactic: ${Math.round(maatData.cosmicSync.galactic * 100)}%`;
      
      if (maatData.stable) {
        stabilityEl.textContent = 'âœ“ LYAPUNOV STABLE';
        stabilityEl.className = 'stability-indicator stable';
      } else {
        stabilityEl.textContent = 'âš  DESTABILIZED';
        stabilityEl.className = 'stability-indicator unstable';
      }
      
      // Display Ma'at response
      setTimeout(() => {
        const maatDiv = document.createElement('div');
        maatDiv.className = 'message maat';
        maatDiv.innerHTML = `
          <div class="message-sender">â˜¥ MA'AT ENGINE:</div>
          ${maatData.response}
          ${maatData.recommendation ? `<br><br><em style="opacity: 0.8;">${maatData.recommendation}</em>` : ''}
        `;
        messagesContainer.appendChild(maatDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }, 500);
    }

    // =====================================================
    // CANVAS 2D HOLOGRAPHIC GLYPH
    // =====================================================
    const canvas = document.getElementById('maat-glyph');
    const ctx = canvas.getContext('2d');
    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;
    
    let rotation = 0;
    let currentColor = { r: 33, g: 150, b: 243 }; // Blue (Neutral)
    let targetColor = { r: 33, g: 150, b: 243 };
    let currentScale = 1.0;
    let targetScale = 1.0;
    let coherenceValue = 0.847;
    
    function drawAnkh(scale, color, alpha) {
      ctx.save();
      ctx.translate(centerX, centerY);
      ctx.rotate(rotation);
      ctx.scale(scale, scale);
      
      ctx.strokeStyle = `rgba(${Math.round(color.r)}, ${Math.round(color.g)}, ${Math.round(color.b)}, ${alpha})`;
      ctx.fillStyle = `rgba(${Math.round(color.r)}, ${Math.round(color.g)}, ${Math.round(color.b)}, ${alpha * 0.3})`;
      ctx.lineWidth = 3;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      
      // Draw ankh loop (circle at top)
      ctx.beginPath();
      ctx.arc(0, -40, 25, 0, Math.PI * 2);
      ctx.stroke();
      ctx.fill();
      
      // Draw vertical bar
      ctx.beginPath();
      ctx.moveTo(0, -15);
      ctx.lineTo(0, 80);
      ctx.lineWidth = 12;
      ctx.stroke();
      
      // Draw horizontal bar
      ctx.beginPath();
      ctx.moveTo(-40, 20);
      ctx.lineTo(40, 20);
      ctx.lineWidth = 12;
      ctx.stroke();
      
      // Add glow effect
      ctx.shadowBlur = 20 * coherenceValue;
      ctx.shadowColor = `rgba(${Math.round(color.r)}, ${Math.round(color.g)}, ${Math.round(color.b)}, 0.8)`;
      
      ctx.restore();
    }
    
    function drawParticles() {
      const particleCount = 50;
      const time = Date.now() * 0.001;
      
      for (let i = 0; i < particleCount; i++) {
        const angle = (i / particleCount) * Math.PI * 2 + time * 0.5;
        const distance = 100 + Math.sin(time * 2 + i) * 20;
        const x = centerX + Math.cos(angle) * distance;
        const y = centerY + Math.sin(angle) * distance;
        const size = 2 + Math.sin(time * 3 + i) * 1;
        
        ctx.fillStyle = `rgba(${Math.round(currentColor.r)}, ${Math.round(currentColor.g)}, ${Math.round(currentColor.b)}, ${coherenceValue * 0.5})`;
        ctx.beginPath();
        ctx.arc(x, y, size, 0, Math.PI * 2);
        ctx.fill();
      }
    }
    
    function animate() {
      // Clear canvas with fade effect
      ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // Smooth color transition
      currentColor.r += (targetColor.r - currentColor.r) * 0.05;
      currentColor.g += (targetColor.g - currentColor.g) * 0.05;
      currentColor.b += (targetColor.b - currentColor.b) * 0.05;
      
      // Smooth scale transition
      currentScale += (targetScale - currentScale) * 0.05;
      
      // Draw particles
      drawParticles();
      
      // Draw main ankh
      drawAnkh(currentScale, currentColor, 0.9);
      
      // Draw glow layer
      drawAnkh(currentScale * 1.1, currentColor, 0.2);
      
      // Update rotation
      rotation += 0.01 * coherenceValue;
      
      requestAnimationFrame(animate);
    }
    
    animate();
    
    // Update glyph based on Ma'at data
    function updateGlyph(maatData) {
      coherenceValue = maatData.coherence / 100;
      targetScale = 0.7 + coherenceValue * 0.5;
      
      // Update color based on emotional field
      if (maatData.emotionalField === 'Positive') {
        targetColor = { r: 76, g: 175, b: 80 }; // Green
      } else if (maatData.emotionalField === 'Neutral') {
        targetColor = { r: 33, g: 150, b: 243 }; // Blue
      } else {
        targetColor = { r: 244, g: 67, b: 54 }; // Red
      }
    }

    // =====================================================
    // MA'AT VALIDATION ENGINE
    // =====================================================
    function validateWithMaat(message) {
      const words = message.toLowerCase().split(/\s+/);
      const detectedPrinciples = [];
      let coherenceScore = 0.5;
      let totalFrequency = 0;
      
      // Detect principles
      MAAT_PRINCIPLES.forEach(principle => {
        const matches = principle.keyword.filter(keyword => 
          words.some(word => word.includes(keyword) || keyword.includes(word))
        );
        if (matches.length > 0) {
          detectedPrinciples.push(principle);
          coherenceScore += 0.08 * matches.length;
          totalFrequency += principle.frequency;
        }
      });
      
      // Analyze emotional content
      const positiveWords = ['love', 'joy', 'peace', 'happy', 'grateful', 'blessed', 'hope', 'light', 'harmony'];
      const negativeWords = ['hate', 'anger', 'fear', 'conflict', 'dark', 'confused', 'lost', 'doubt', 'chaos'];
      
      let emotionalScore = 0;
      words.forEach(word => {
        if (positiveWords.some(pw => word.includes(pw))) emotionalScore += 0.15;
        if (negativeWords.some(nw => word.includes(nw))) emotionalScore -= 0.15;
      });
      
      coherenceScore = Math.min(0.95, Math.max(0.3, coherenceScore + emotionalScore));
      
      let emotionalField = coherenceScore > 0.75 ? 'Positive' 
        : coherenceScore > 0.55 ? 'Neutral' : 'Negative';
      
      const avgFrequency = detectedPrinciples.length > 0 
        ? Math.round(totalFrequency / detectedPrinciples.length)
        : 528;
      
      const lunarSync = 0.75 + Math.random() * 0.2;
      const galacticSync = 0.65 + Math.random() * 0.2;
      const isStable = coherenceScore > 0.5;
      
      let response = '';
      if (detectedPrinciples.length > 0) {
        const principleNames = detectedPrinciples.map(p => `${p.name} (#${p.id})`).slice(0, 3).join(', ');
        response = `Your thought resonates with: ${principleNames}. `;
        response += `The glyph shows ${emotionalField.toUpperCase()} energy. `;
        
        if (coherenceScore > 0.8) {
          response += 'Excellent alignment! Your intent is clear and powerful. âœ¨';
        } else if (coherenceScore > 0.6) {
          response += 'Good alignment. Consider deepening your connection to these principles. ðŸŒŸ';
        } else {
          response += 'Refinement suggested. Clarify your intent and reconnect with your core principles. ðŸ’«';
        }
      } else {
        response = `No specific principles detected. Try focusing your thought with keywords like truth, justice, harmony, or balance. The glyph reflects ${emotionalField.toLowerCase()} energy.`;
      }
      
      return {
        coherence: coherenceScore * 100,
        emotionalField: emotionalField,
        principles: detectedPrinciples.length > 0 
          ? detectedPrinciples.map(p => p.id).slice(0, 5).join(', ')
          : 'None',
        principleNames: detectedPrinciples.map(p => p.name).slice(0, 3),
        frequency: avgFrequency,
        cosmicSync: { lunar: lunarSync, galactic: galacticSync },
        stable: isStable,
        response: response,
        recommendation: detectedPrinciples.length > 0 
          ? `Focus on embodying ${detectedPrinciples[0].name} in your actions.`
          : 'Meditate on the MA\'AT principles to find your alignment.'
      };
    }

    // =====================================================
    // CHAT INTERFACE
    // =====================================================
    const form = document.getElementById('form');
    const input = document.getElementById('input');
    const messagesContainer = document.getElementById('messages');
    
    const coherenceEl = document.getElementById('coherence');
    const emotionalEl = document.getElementById('emotional');
    const principlesEl = document.getElementById('principles');
    const frequencyEl = document.getElementById('frequency');
    const cosmicSyncEl = document.getElementById('cosmic-sync');
    const stabilityEl = document.getElementById('stability');
    
    form.addEventListener('submit', (e) => {
      e.preventDefault();
      
      const userMessage = input.value.trim();
      if (!userMessage) return;
      
      // Display user message
      const userDiv = document.createElement('div');
      userDiv.className = 'message user';
      userDiv.innerHTML = `<div class="message-sender">YOU:</div>${userMessage}`;
      messagesContainer.appendChild(userDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
      
      input.value = '';
      
      // Handle validation based on mode
      if (!USE_LOCAL_ENGINE && sendToRemoteEngine(userMessage)) {
        // Message sent to remote engine, response will come via WebSocket
        console.log('â˜¥ Message sent to remote Ma\'at Engine');
      } else {
        // Use local validation
        processLocalValidation(userMessage);
      }
    });
    
    function processLocalValidation(userMessage) {
      // Process with local Ma'at engine
      const maatData = validateWithMaat(userMessage);
      
      // Update glyph
      updateGlyph(maatData);
      
      // Update metrics
      coherenceEl.textContent = maatData.coherence.toFixed(1) + '%';
      emotionalEl.textContent = maatData.emotionalField;
      principlesEl.textContent = maatData.principles;
      frequencyEl.textContent = maatData.frequency + ' Hz';
      cosmicSyncEl.textContent = `Lunar: ${Math.round(maatData.cosmicSync.lunar * 100)}% | Galactic: ${Math.round(maatData.cosmicSync.galactic * 100)}%`;
      
      if (maatData.stable) {
        stabilityEl.textContent = 'âœ“ LYAPUNOV STABLE';
        stabilityEl.className = 'stability-indicator stable';
      } else {
        stabilityEl.textContent = 'âš  DESTABILIZED';
        stabilityEl.className = 'stability-indicator unstable';
      }
      
      // Display Ma'at response
      setTimeout(() => {
        const maatDiv = document.createElement('div');
        maatDiv.className = 'message maat';
        maatDiv.innerHTML = `
          <div class="message-sender">â˜¥ MA'AT:</div>
          ${maatData.response}
          <br><br>
          <em style="opacity: 0.8;">${maatData.recommendation}</em>
        `;
        messagesContainer.appendChild(maatDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }, 500);
    }
    
    // Initialize WebSocket if not in local mode
    initWebSocket();
    
    console.log('â˜¥ MA\'AT Unity Interface initialized');
    console.log(`â˜¥ Mode: ${USE_LOCAL_ENGINE ? 'LOCAL SIMULATION' : 'WEBSOCKET CONNECTED'}`);
    console.log('â˜¥ 42 Principles loaded with sacred frequencies (432-852 Hz)');
    console.log('â˜¥ Canvas 2D glyph active and responding to input');
  </script>
</body>
</html>
